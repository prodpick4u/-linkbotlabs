<div class="container">
    <h2>üé¨ LinkBotLabs AI Video Generator</h2>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>

    <!-- Step 1: URL Preview -->
    <label>Step 1: Enter Product URLs (comma separated)</label>
    <input type="text" id="urls" placeholder="https://example.com/product1, https://example.com/product2">
    <button type="button" id="previewUrlsBtn">Preview Products</button>
    <div id="url_preview"></div>

    <!-- Step 2: DALL¬∑E Images -->
    <label>Step 2: Optional DALL¬∑E 3 Image Prompt</label>
    <input type="text" id="dalle_prompt" placeholder="e.g., 'Modern kitchen with kettle'">
    <button type="button" id="generateDalleBtn">Generate Image</button>
    <div id="dalle_images"></div>

    <!-- Step 3: Video Generation -->
    <button type="button" id="generateVideoBtn">Generate Video</button>
    <div id="video_steps"></div>

    <video id="video_preview" controls style="display:none;"></video>
</div>

<script>
let dalleImages = [];
let generatingImage = false;

// ---------------------------
// Step 1: Preview URLs with per-URL progress
// ---------------------------
document.getElementById('previewUrlsBtn').addEventListener('click', async function() {
    const urls = document.getElementById('urls').value.split(',').map(u=>u.trim()).filter(Boolean);
    const previewEl = document.getElementById('url_preview');
    previewEl.innerHTML = '';
    if(!urls.length) return alert('Enter at least one URL');

    try {
        let step = 0;
        for(const url of urls){
            const div = document.createElement('div');
            div.textContent = `Fetching ${url}... 0%`;
            previewEl.appendChild(div);

            // Simulate fetch progress (replace with actual fetch if needed)
            for(let p=10; p<=100; p+=10){
                await new Promise(r=>setTimeout(r, 50)); // simulate progress
                div.textContent = `Fetching ${url}... ${p}%`;
            }

            // Here you would fetch actual title/description
            const res = await fetch(`/preview_url?url=${encodeURIComponent(url)}`);
            const data = await res.json();
            div.innerHTML = `<strong>${url}</strong><br>Title: ${data.title||'N/A'}<br>Description: ${data.description||'N/A'}`;
        }
    } catch(err){
        console.error(err);
        previewEl.innerHTML = '‚ùå Failed to fetch product info';
    }
});

// ---------------------------
// Step 2: DALL¬∑E per-image progress
// ---------------------------
document.getElementById('generateDalleBtn').addEventListener('click', async function() {
    const prompt = document.getElementById('dalle_prompt').value.trim();
    if(!prompt) return alert('Enter a prompt');
    if(generatingImage) return alert('Please wait...');
    generatingImage = true;

    const container = document.getElementById('dalle_images');
    const imgDiv = document.createElement('div');
    imgDiv.textContent = `Generating image for prompt "${prompt}"... 0%`;
    container.appendChild(imgDiv);

    try {
        // Simulate progress
        for(let p=10; p<=100; p+=10){
            await new Promise(r=>setTimeout(r, 100)); // simulate progress
            imgDiv.textContent = `Generating image for prompt "${prompt}"... ${p}%`;
        }
        const imgEl = await puter.ai.txt2img(prompt);
        imgDiv.innerHTML = '';
        imgDiv.appendChild(imgEl);
        dalleImages.push(imgEl.src);
    } catch(err){
        console.error(err);
        imgDiv.textContent = '‚ùå Failed to generate image';
    } finally {
        generatingImage = false;
    }
});

// ---------------------------
// Step 3: Video generation with multiple progress steps
// ---------------------------
document.getElementById('generateVideoBtn').addEventListener('click', async function() {
    const videoStepsEl = document.getElementById('video_steps');
    videoStepsEl.innerHTML = '';
    const videoEl = document.getElementById('video_preview');
    videoEl.style.display = 'none';
    videoEl.src = '';

    const urls = document.getElementById('urls').value.split(',').map(u=>u.trim()).filter(Boolean);
    const scriptText = document.getElementById('script').value.trim();
    const steps = [
        {name:'Preparing script', progress:0},
        {name:'Generating TTS', progress:0},
        {name:'Sending assets to backend', progress:0},
        {name:'Processing video', progress:0},
        {name:'Video ready', progress:100}
    ];

    try {
        const stepEls = steps.map(s=>{
            const div = document.createElement('div');
            div.textContent = `${s.name}: ${s.progress}%`;
            videoStepsEl.appendChild(div);
            return div;
        });

        // Step 1: Prepare script
        if(!scriptText){
            const prompt = `Write a short, engaging TikTok-style narration for these products: ${urls.join(', ')}. Max 1600 chars.`;
            steps[0].progress = 50; stepEls[0].textContent = `${steps[0].name}: ${steps[0].progress}%`;
            await new Promise(r=>setTimeout(r, 500)); // simulate
            const generated = await puter.ai.chat(prompt, { model: "gpt-5-nano" });
            steps[0].progress = 100; stepEls[0].textContent = `${steps[0].name}: 100%`;
        }

        // Step 2: TTS
        steps[1].progress = 0; stepEls[1].textContent = `${steps[1].name}: 0%`;
        const ttsBlob = await puter.ai.tts(scriptText||generated, { voice: "alloy" });
        for(let p=10;p<=100;p+=10){
            await new Promise(r=>setTimeout(r,50));
            steps[1].progress = p; stepEls[1].textContent = `${steps[1].name}: ${p}%`;
        }

        const ttsFile = new File([ttsBlob], "voice.mp3", { type: "audio/mpeg" });

        // Step 3: Sending assets
        steps[2].progress = 50; stepEls[2].textContent = `${steps[2].name}: 50%`;
        await new Promise(r=>setTimeout(r,500));
        steps[2].progress = 100; stepEls[2].textContent = `${steps[2].name}: 100%`;

        // Step 4: Video processing
        steps[3].progress = 0; stepEls[3].textContent = `${steps[3].name}: 0%`;
        for(let p=10;p<=100;p+=10){
            await new Promise(r=>setTimeout(r,200));
            steps[3].progress = p; stepEls[3].textContent = `${steps[3].name}: ${p}%`;
        }

        // Step 5: Finished
        steps[4].progress = 100; stepEls[4].textContent = `${steps[4].name}: 100%`;

        // Simulate backend response
        videoEl.src = `/download/demo_video.mp4`; 
        videoEl.style.display = 'block';
    } catch(err){
        console.error(err);
        const errDiv = document.createElement('div');
        errDiv.textContent = '‚ùå Video generation failed';
        videoStepsEl.appendChild(errDiv);
    }
});
</script>
