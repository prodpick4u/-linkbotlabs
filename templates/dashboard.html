<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinkBotLabs AI Video Generator</title>
<script src="https://js.puter.com/v2/"></script>
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
.container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
input, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border-radius: 4px; border: 1px solid #ccc; }
button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
button:hover { background: #0056b3; }
video, img { width: 100%; margin-top: 15px; border-radius: 6px; }
#dalle_images img { margin-bottom: 10px; }
.error { color: red; }
.success { color: green; }
.progress-container { background: #ddd; border-radius: 5px; overflow: hidden; margin: 10px 0; }
.progress-bar { width: 0%; height: 20px; background: #28a745; text-align: center; color: white; line-height: 20px; }
#url_preview div { margin-bottom: 10px; padding: 5px; background: #f8f9fa; border-radius: 4px; }
</style>
</head>
<body>

<div class="container">
    <h2>üé¨ LinkBotLabs AI Video Generator</h2>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>

    <!-- Step 1: URL Preview -->
    <label>Step 1: Enter Product URLs (comma separated)</label>
    <input type="text" id="urls" placeholder="https://example.com/product1, https://example.com/product2">
    <button type="button" id="previewUrlsBtn">Preview Products</button>
    <div class="progress-container"><div class="progress-bar" id="urlProgress">0%</div></div>
    <div id="url_preview"></div>

    <!-- Step 2: Optional AI Inputs -->
    <label>Step 2: Optional Script / Narration</label>
    <textarea id="script" rows="4" placeholder="Optional: leave blank to auto-generate"></textarea>

    <label>Step 3: Optional DALL¬∑E 3 Image Prompt</label>
    <input type="text" id="dalle_prompt" placeholder="e.g., 'Modern kitchen with kettle'">
    <button type="button" id="generateDalleBtn">Generate Image</button>
    <div class="progress-container"><div class="progress-bar" id="dalleProgress">0%</div></div>
    <div id="dalle_images"></div>

    <button type="button" id="generateVideoBtn">Generate Video</button>
    <div class="progress-container"><div class="progress-bar" id="videoProgress">0%</div></div>

    <video id="video_preview" controls style="display:none;"></video>
</div>

<script>
let dalleImages = [];
let generatingImage = false;

function updateProgress(barId, percent, text=null){
    const bar = document.getElementById(barId);
    bar.style.width = percent + "%";
    bar.textContent = text || percent + "%";
}

// ---------------------------
// Step 1: Preview URLs
// ---------------------------
document.getElementById('previewUrlsBtn').addEventListener('click', async function() {
    const urls = document.getElementById('urls').value.split(',').map(u=>u.trim()).filter(Boolean);
    const previewEl = document.getElementById('url_preview');
    previewEl.innerHTML = '';
    if(!urls.length) return alert('Enter at least one URL');
    updateProgress('urlProgress', 0, 'Starting URL preview');

    try {
        let step = 0;
        for(const url of urls){
            const res = await fetch(`/preview_url?url=${encodeURIComponent(url)}`);
            const data = await res.json();
            const div = document.createElement('div');
            div.innerHTML = `<strong>${url}</strong><br>Title: ${data.title||'N/A'}<br>Description: ${data.description||'N/A'}`;
            previewEl.appendChild(div);
            step++;
            updateProgress('urlProgress', Math.floor((step/urls.length)*100));
        }
    } catch(err){
        console.error(err);
        previewEl.innerHTML = '‚ùå Failed to fetch product info';
        updateProgress('urlProgress', 0);
    }
});

// ---------------------------
// Step 2: DALL¬∑E 3 Image
// ---------------------------
document.getElementById('generateDalleBtn').addEventListener('click', async function() {
    const prompt = document.getElementById('dalle_prompt').value.trim();
    if(!prompt) return alert('Enter a prompt');
    if(generatingImage) return alert('Please wait...');
    generatingImage = true;
    updateProgress('dalleProgress', 0, 'Generating image...');

    try {
        const imgEl = await puter.ai.txt2img(prompt);
        document.getElementById('dalle_images').appendChild(imgEl);
        dalleImages.push(imgEl.src);
        updateProgress('dalleProgress', 100, 'Image ready');
    } catch(err){
        console.error(err);
        alert('‚ùå Failed to generate image');
        updateProgress('dalleProgress', 0);
    } finally {
        generatingImage = false;
    }
});

// ---------------------------
// Step 3: Generate Video
// ---------------------------
document.getElementById('generateVideoBtn').addEventListener('click', async function() {
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');
    const videoEl = document.getElementById('video_preview');
    errorEl.textContent = '';
    successEl.textContent = '';
    videoEl.style.display = 'none';
    videoEl.src = '';
    updateProgress('videoProgress', 0, 'Starting video generation');

    let urls = document.getElementById('urls').value.split(',').map(u => u.trim()).filter(Boolean);
    let scriptText = document.getElementById('script').value.trim();
    try {
        // Auto-generate script if blank
        if(!scriptText){
            const prompt = `Write a short, engaging TikTok-style narration for these products: ${urls.join(', ')}. Max 1600 characters.`;
            scriptText = await puter.ai.chat(prompt, { model: "gpt-5-nano" });
        }

        updateProgress('videoProgress', 25, 'Generating voiceover');
        const ttsBlob = await puter.ai.tts(scriptText, { voice: "alloy" });
        const ttsFile = new File([ttsBlob], "voice.mp3", { type: "audio/mpeg" });

        const formData = new FormData();
        formData.append("urls", JSON.stringify([...urls, ...dalleImages]));
        formData.append("script", scriptText);
        formData.append("voiceover", ttsFile);

        updateProgress('videoProgress', 50, 'Sending to backend');
        const response = await fetch('/generate_video', { method: 'POST', body: formData });
        const data = await response.json();

        if(data.video_file){
            updateProgress('videoProgress', 100, 'Video ready');
            successEl.textContent = '‚úÖ Video generated!';
            videoEl.src = `/download/${data.video_file}`;
            videoEl.style.display = 'block';
        } else {
            updateProgress('videoProgress', 0);
            errorEl.textContent = '‚ùå Video generation failed: ' + (data.error || 'Unknown error');
        }
    } catch(err){
        console.error(err);
        updateProgress('videoProgress', 0);
        errorEl.textContent = '‚ùå Failed to generate video';
    }
});
</script>

</body>
</html>
