<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinkBotLabs AI Video Generator</title>
<script src="https://js.puter.com/v2/"></script>
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
.container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
input, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border-radius: 4px; border: 1px solid #ccc; }
button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
button:hover { background: #0056b3; }
video, img { width: 100%; margin-top: 15px; border-radius: 6px; }
.error { color: red; }
.success { color: green; }
#dalle_images { display: flex; flex-wrap: wrap; gap: 10px; }
.image-box { position: relative; display: inline-block; }
.image-box input[type="checkbox"] { position: absolute; top: 5px; left: 5px; width: 20px; height: 20px; }
progress { width: 100%; height: 15px; margin-bottom: 15px; }
</style>
</head>
<body>
<div class="container">
    <h2>üé¨ LinkBotLabs AI Video Generator</h2>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>

    <label>Product URLs (comma separated)</label>
    <input type="text" id="urls" placeholder="https://example.com/product1, https://example.com/product2">

    <label>Optional Script / Narration</label>
    <textarea id="script" rows="4" placeholder="Optional: leave blank to auto-generate"></textarea>

    <label>Optional DALL¬∑E 3 Image Prompt</label>
    <input type="text" id="dalle_prompt" placeholder="e.g., 'Modern kitchen with kettle'">
    <button type="button" id="generateDalleBtn">Generate Images</button>
    <div id="dalle_images"></div>

    <h3>Pipeline Progress</h3>
    <div>1Ô∏è‚É£ Fetch Product Images</div><progress id="step1" value="0" max="100"></progress>
    <div>2Ô∏è‚É£ AI Script Generation</div><progress id="step2" value="0" max="100"></progress>
    <div>3Ô∏è‚É£ DALL¬∑E Images</div><progress id="step3" value="0" max="100"></progress>
    <div>4Ô∏è‚É£ TTS / Voiceover</div><progress id="step4" value="0" max="100"></progress>
    <div>5Ô∏è‚É£ Video Assembly</div><progress id="step5" value="0" max="100"></progress>

    <button type="button" id="generateVideoBtn">Generate Video</button>

    <video id="video_preview" controls style="display:none;"></video>
</div>

<script>
let dalleImages = [];
let generatingImage = false;

async function updateProgress(step, percent) {
    document.getElementById(`step${step}`).value = percent;
}

// Generate DALL¬∑E images
document.getElementById('generateDalleBtn').addEventListener('click', async function() {
    const prompt = document.getElementById('dalle_prompt').value.trim();
    if(!prompt) return alert('Enter a prompt');
    if(generatingImage) return alert('Please wait...');
    generatingImage = true;
    updateProgress(3, 10);

    try {
        const imgEl = await puter.ai.txt2img(prompt); 
        const container = document.createElement('div');
        container.classList.add('image-box');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        container.appendChild(imgEl);
        container.appendChild(checkbox);
        document.getElementById('dalle_images').appendChild(container);
        dalleImages.push({ src: imgEl.src, element: container });
        updateProgress(3, 100);
    } catch(err) {
        console.error(err);
        alert('‚ùå Failed to generate image.');
    } finally {
        generatingImage = false;
    }
});

// Generate Video
document.getElementById('generateVideoBtn').addEventListener('click', async function() {
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');
    const videoEl = document.getElementById('video_preview');
    errorEl.textContent = '';
    successEl.textContent = '';
    videoEl.style.display = 'none';
    videoEl.src = '';

    let urls = document.getElementById('urls').value.split(',').map(u => u.trim()).filter(Boolean);
    if(!urls.length) {
        errorEl.textContent = '‚ùå Please enter at least one URL.';
        return;
    }
    await updateProgress(1, 50);

    let scriptText = document.getElementById('script').value.trim();
    if(!scriptText) {
        updateProgress(2, 10);
        const prompt = `Write a short, engaging TikTok-style narration for these products: ${urls.join(', ')}. Max 1600 characters.`;
        scriptText = await puter.ai.chat(prompt, { model: "gpt-5-nano" });
        updateProgress(2, 100);
    }

    // Collect selected DALL¬∑E images
    const selectedImages = dalleImages.filter(img => img.element.querySelector('input').checked).map(img => img.src);
    await updateProgress(3, 100);

    // Generate TTS
    updateProgress(4, 10);
    const ttsBlob = await puter.ai.tts(scriptText, { voice: "alloy" });
    const ttsFile = new File([ttsBlob], "voice.mp3", { type: "audio/mpeg" });
    updateProgress(4, 100);

    // Send to backend
    const formData = new FormData();
    formData.append("urls", JSON.stringify([...urls, ...selectedImages]));
    formData.append("script", scriptText);
    formData.append("voiceover", ttsFile);

    updateProgress(5, 10);
    const response = await fetch('/generate_video', { method: 'POST', body: formData });
    const data = await response.json();
    updateProgress(5, 100);

    if(data.video_file){
        successEl.textContent = '‚úÖ Video generated!';
        videoEl.src = `/download/${data.video_file}`;
        videoEl.style.display = 'block';
    } else {
        errorEl.textContent = '‚ùå Video generation failed: ' + (data.error || 'Unknown error');
    }
});
</script>
</body>
</html>
