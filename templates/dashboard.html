<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinkBotLabs Video Generator</title>
<script src="https://js.puter.com/v2/"></script>
<style>
/* ... (same styling as before) ... */
</style>
</head>
<body>

<!-- Password Overlay -->
<div id="passwordOverlay">
  <h2>üîí Enter Dashboard Password</h2>
  <input type="password" id="dashboardPassword" placeholder="Password">
  <button id="submitPassword">Submit</button>
  <p id="pwError">‚ùå Incorrect password</p>
</div>

<!-- Main Container -->
<div class="container" id="dashboardContent" style="display:none;">
  <h2>üé¨ LinkBotLabs Video Generator</h2>

  <label>Step 1: Enter Product URL(s) <span class="optional">(Required)</span></label>
  <input type="text" id="urls" placeholder="https://example.com/product1, https://example.com/product2">

  <label>Step 2: Optional Script / Narration <span class="optional">(AI generates if blank)</span></label>
  <textarea id="script" rows="3" placeholder="Optional: Enter your own narration text here"></textarea>

  <label>Step 3: Optional AI Image Prompt <span class="optional">(Extra visuals)</span></label>
  <input type="text" id="dalle_prompt" placeholder="e.g., 'Modern kitchen with kettle'">
  <button type="button" id="generateDalleBtn">Generate Image</button>
  <div id="dalle_images"></div>

  <button type="button" id="generateVideoBtn">Generate Video</button>
  <div id="loading">‚è≥ Please wait... generating...</div>

  <video id="video_preview" controls style="display:none;"></video>
  <a id="download_link" href="#" download class="download-link" style="display:none;">Download Video</a>
</div>

<script>
const correctPassword = "supersecret";
const overlay = document.getElementById('passwordOverlay');
const input = document.getElementById('dashboardPassword');
const btn = document.getElementById('submitPassword');
const pwError = document.getElementById('pwError');
const dashboard = document.getElementById('dashboardContent');

btn.addEventListener('click', () => {
    if(input.value === correctPassword){
        overlay.style.display = 'none';
        dashboard.style.display = 'block';
    } else {
        pwError.style.display = 'block';
        input.value = '';
    }
});
input.addEventListener('keypress', (e) => { if(e.key==='Enter') btn.click(); });

const inputs = document.querySelectorAll('input, textarea');
inputs.forEach(input => input.addEventListener('focus', () => {
    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
}));

let dalleImages = [];
let generatingImage = false;

// Generate DALL-E image
document.getElementById('generateDalleBtn').addEventListener('click', async function(){
    const prompt = document.getElementById('dalle_prompt').value.trim();
    if(!prompt) return alert('Enter a prompt for image generation');
    if(generatingImage) return;
    generatingImage = true;
    document.getElementById('loading').style.display = 'block';
    this.disabled = true;

    try {
        const imgEl = await puter.ai.txt2img(prompt);
        document.getElementById('dalle_images').appendChild(imgEl);
        dalleImages.push(imgEl.src);
    } catch(err) {
        console.error(err);
        alert('‚ùå Failed to generate image. Try again.');
    } finally {
        generatingImage = false;
        document.getElementById('loading').style.display = 'none';
        this.disabled = false;
    }
});

// Generate video
document.getElementById('generateVideoBtn').addEventListener('click', async function(){
    const urls = document.getElementById('urls').value.split(',').map(u=>u.trim()).filter(Boolean);
    if(!urls.length) return alert('‚ùå Please enter at least one URL');
    
    let scriptText = document.getElementById('script').value.trim();
    document.getElementById('loading').style.display = 'block';

    try {
        if(!scriptText){
            const prompt = `Write a short, engaging TikTok-style narration for these products: ${urls.join(', ')}. Highlight benefits, visuals, and call-to-action. Max 1600 characters.`;
            scriptText = await puter.ai.chat(prompt, { model: "gpt-5-nano" });
        }

        const allImages = [...dalleImages, ...urls];

        const response = await fetch('/generate_video', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({urls:allImages, script:scriptText})
        });
        const data = await response.json();
        document.getElementById('loading').style.display = 'none';

        if(data.video_file){
            const videoEl = document.getElementById('video_preview');
            const downloadEl = document.getElementById('download_link');
            videoEl.src = `/download/${data.video_file}`;
            videoEl.style.display = 'block';
            downloadEl.href = `/download/${data.video_file}`;
            downloadEl.style.display = 'block';
        } else {
            alert('‚ùå Video generation failed: ' + (data.error||'Unknown error'));
        }

    } catch(err){
        console.error(err);
        document.getElementById('loading').style.display = 'none';
        alert('‚ùå Failed to generate video. Try again.');
    }
});
</script>
</body>
</html>
