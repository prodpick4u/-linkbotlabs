<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinkBotLabs AI Video Generator</title>
<script src="https://js.puter.com/v2/"></script>
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
.container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
input, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border-radius: 4px; border: 1px solid #ccc; }
button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
button:hover { background: #0056b3; }
video, img { width: 100%; margin-top: 15px; border-radius: 6px; }
.error { color: red; }
.success { color: green; }
.progress-container { margin-top: 10px; }
.progress-bar { width: 0%; height: 20px; background: #28a745; border-radius: 4px; transition: width 0.3s; }
.progress-text { margin-top: 5px; font-size: 0.9em; }
#dalle_images img { margin-bottom: 10px; }
</style>
</head>
<body>

<div class="container">
    <h2>üé¨ LinkBotLabs AI Video Generator</h2>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>

    <label>Product URLs (comma separated)</label>
    <input type="text" id="urls" placeholder="https://example.com/product1, https://example.com/product2">

    <label>Optional Script / Narration</label>
    <textarea id="script" rows="4" placeholder="Optional: leave blank to auto-generate"></textarea>

    <label>Optional DALL¬∑E 3 Image Prompt</label>
    <input type="text" id="dalle_prompt" placeholder="e.g., 'Modern kitchen with kettle'">
    <button type="button" id="generateDalleBtn">Generate Image</button>
    <div id="dalle_images"></div>

    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-text" id="progressText">Idle</div>
    </div>

    <button type="button" id="generateVideoBtn">Generate Video</button>
    <video id="video_preview" controls style="display:none;"></video>
</div>

<script>
let dalleImages = [];
let generatingImage = false;

// Generate DALL-E image
document.getElementById('generateDalleBtn').addEventListener('click', async function() {
    const prompt = document.getElementById('dalle_prompt').value.trim();
    if(!prompt) return alert('Enter a prompt');
    if(generatingImage) return alert('Please wait...');
    generatingImage = true;

    try {
        const imgEl = await puter.ai.txt2img(prompt);
        document.getElementById('dalle_images').appendChild(imgEl);
        dalleImages.push(imgEl.src);
    } catch(err) {
        console.error(err);
        alert('‚ùå Failed to generate image.');
    } finally {
        generatingImage = false;
    }
});

// Generate video with progress
document.getElementById('generateVideoBtn').addEventListener('click', function() {
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');
    const videoEl = document.getElementById('video_preview');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    errorEl.textContent = '';
    successEl.textContent = '';
    videoEl.style.display = 'none';
    videoEl.src = '';
    progressBar.style.width = '0%';
    progressText.textContent = 'Starting...';

    const urls = document.getElementById('urls').value.split(',').map(u => u.trim()).filter(Boolean);
    const scriptText = document.getElementById('script').value.trim();

    if(!urls.length && !dalleImages.length) {
        errorEl.textContent = '‚ùå Enter at least one URL or DALL¬∑E prompt.';
        return;
    }

    // SSE connection to backend
    const evtSource = new EventSource('/generate_video_stream');
    evtSource.onopen = () => { progressText.textContent = 'Connected to server...'; };
    evtSource.onmessage = (e) => {
        const data = JSON.parse(e.data);
        progressText.textContent = data.step || 'Processing...';
        if(data.progress) progressBar.style.width = data.progress + '%';
        if(data.video_file){
            successEl.textContent = '‚úÖ Video generated!';
            videoEl.src = `/download/${data.video_file}`;
            videoEl.style.display = 'block';
            progressBar.style.width = '100%';
            progressText.textContent = 'Completed';
            evtSource.close();
        }
        if(data.error){
            errorEl.textContent = '‚ùå ' + data.error;
            evtSource.close();
        }
    };
    evtSource.onerror = (err) => {
        errorEl.textContent = '‚ùå Connection error.';
        evtSource.close();
    };

    // Send JSON payload
    fetch('/generate_video_stream', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
            urls: urls,
            dalle_prompts: dalleImages,
            script: scriptText
        })
    }).catch(err => { console.error(err); errorEl.textContent='‚ùå Failed to start generation'; });
});
</script>
</body>
</html>
