<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Generator Dashboard</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        input[type="text"], textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #0056b3; }
        .error { color: red; margin-bottom: 15px; }
        .success { color: green; margin-bottom: 15px; }
        video, img { width: 100%; margin-top: 15px; border-radius: 6px; }
        #dalle_images img { margin-bottom: 10px; }
    </style>
</head>
<body>
<div class="container">
    <h2>Welcome, {{ user }}</h2>
    <p><a href="{{ url_for('logout') }}">Logout</a></p>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>

    <form id="videoForm">
        <label for="urls">Product Page URLs (comma separated):</label>
        <input type="text" id="urls" placeholder="https://example.com/product1, https://example.com/product2" required>

        <label for="script">Optional Script (leave empty to auto-generate):</label>
        <textarea id="script" rows="4" placeholder="Enter text for narration or captions"></textarea>

        <label for="dalle_prompt">Optional DALL·E 3 Images:</label>
        <input type="text" id="dalle_prompt" placeholder="Describe an image to include">
        <button type="button" onclick="generateDalleImage()">Generate Image</button>
        <div id="dalle_images"></div>

        <button type="submit">Generate Video</button>
    </form>

    <video id="video_preview" controls style="display:none;"></video>
</div>

<script>
let dalleImages = [];

async function generateDalleImage() {
    const prompt = document.getElementById('dalle_prompt').value.trim();
    const container = document.getElementById('dalle_images');
    if (!prompt) return alert('Please enter a prompt for the image.');

    try {
        const imgEl = await puter.ai.txt2img(prompt); // DALL·E 3
        container.appendChild(imgEl);
        dalleImages.push(imgEl.src); // store URL for backend
    } catch (err) {
        console.error(err);
        alert('Failed to generate image.');
    }
}

document.getElementById('videoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');
    const videoEl = document.getElementById('video_preview');
    errorEl.textContent = '';
    successEl.textContent = '';
    videoEl.style.display = 'none';
    videoEl.src = '';

    let urls = document.getElementById('urls').value.split(',').map(u => u.trim()).filter(Boolean);
    if (!urls.length) {
        errorEl.textContent = '❌ Please enter at least one URL.';
        return;
    }

    let scriptText = document.getElementById('script').value.trim();

    try {
        if (!scriptText) {
            const prompt = `Write an engaging TikTok-style narration for these product pages: ${urls.join(', ')}. Highlight benefits, visuals, and call-to-action. Max 1600 characters.`;
            scriptText = await puter.ai.chat(prompt, { model: "gpt-5-nano" });
        }

        // Combine product images + DALL·E images
        const allImages = [...dalleImages, ...urls];

        // Send URLs + script + DALL·E images to Flask backend
        const response = await fetch('/generate_video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ urls: allImages, script: scriptText })
        });

        const data = await response.json();

        if (data.video_file) {
            successEl.textContent = '✅ Video generated successfully!';
            videoEl.src = `/download/${data.video_file}`;
            videoEl.style.display = 'block';
        } else {
            errorEl.textContent = '❌ Video generation failed: ' + (data.error || 'Unknown error');
        }

    } catch (err) {
        console.error(err);
        errorEl.textContent = '❌ Failed to generate video. Please try again.';
    }
});
</script>
</body>
</html>
