<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Playground</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; margin: 0; padding: 1rem; }
    select, button, input { margin: 0.25rem; padding: 0.5rem; }
    #messages { margin-top: 1rem; max-height: 70vh; overflow-y: auto; }
    .msg { padding: 0.5rem; margin: 0.25rem 0; border-radius: 6px; }
    .msg.user { background: #333; }
    .msg.bot { background: #222; }
    #debug-console { margin-top: 1rem; font-size: 0.85rem; color: #aaa; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>AI Playground</h2>

  <label for="model-select">Model:</label>
  <select id="model-select"></select>
  <span id="models-count"></span><br>

  <input id="prompt" placeholder="Type your message..." size="50">
  <button id="send-btn">Send</button>
  <button id="clear-btn">Clear Chat</button>
  <button id="speak-last">ðŸ”Š Speak Last</button>

  <div id="messages"></div>
  <div id="debug-console"></div>

<script>
/* UI references */
const modelSelect = document.getElementById("model-select");
const messagesBox = document.getElementById("messages");
const dbg = document.getElementById("debug-console");

/* Debug helper */
function dbgLog(...args) {
  console.log(...args);
  dbg.innerText += args.map(a => (typeof a === "object" ? JSON.stringify(a) : a)).join(" ") + "\n";
}
function addBotMessage(text, id) {
  const div = document.createElement("div");
  div.className = "msg bot";
  if (id) div.id = id;
  div.textContent = text;
  messagesBox.appendChild(div);
  return div;
}
function replaceBotMessageText(el, text) {
  if (el) el.textContent = text;
}
function addUserMessage(text) {
  const div = document.createElement("div");
  div.className = "msg user";
  div.textContent = text;
  messagesBox.appendChild(div);
}
function safeStringifyError(err) {
  try { return JSON.stringify(err); } catch { return String(err); }
}

/* --- Load models.json --- */
async function loadModelsFromFile() {
  try {
    const res = await fetch("models.json"); // ðŸ‘ˆ your file
    if (!res.ok) throw new Error("HTTP " + res.status);
    const models = await res.json();

    if (Array.isArray(models)) {
      modelSelect.innerHTML = ""; // clear old
      models.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        modelSelect.appendChild(opt);
      });
      document.getElementById("models-count").textContent = models.length + " models";
      dbgLog("Loaded models from models.json:", models);

      // Auto-select first model
      if (models.length > 0) modelSelect.value = models[0];
    } else {
      dbgLog("models.json not an array:", models);
    }
  } catch (err) {
    dbgLog("Error loading models.json:", err);
  }
}

/* --- Send button handler --- */
document.getElementById('send-btn').addEventListener('click', async () => {
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return;
  addUserMessage(prompt);

  const model = modelSelect.value;
  if (!window.puter || !puter.ai) {
    addBotMessage("Error: puter.js not loaded (check network / browser console).");
    return;
  }

  try {
    const id = "bot-" + Date.now();
    const botEl = addBotMessage("", id);
    let full = "";
    const stream = await puter.ai.chat(prompt, { model, stream: true });
    dbgLog("Stream opened:", { model });
    for await (const part of stream) {
      const chunk = (part?.output_text ?? part?.text ?? "");
      full += chunk;
      replaceBotMessageText(botEl, full);
    }
    dbgLog("âœ… Stream complete. full length:", full.length);
  } catch (err) {
    const errStr = safeStringifyError(err);
    dbgLog("ðŸ’¥ Chat error:", errStr);
    addBotMessage("Error â€” see Debug Console (expanded info).");
  }
});

/* --- Speak last assistant message --- */
document.getElementById('speak-last').addEventListener('click', async () => {
  const all = Array.from(document.querySelectorAll('.msg.bot'));
  if (!all.length) {
    dbgLog("No assistant message to speak.");
    return;
  }
  const last = all[all.length - 1].innerText || '';
  if (window.speechSynthesis) {
    const utter = new SpeechSynthesisUtterance(last);
    speechSynthesis.speak(utter);
  } else {
    dbgLog("Speech synthesis not supported in this browser.");
  }
});

/* --- Clear chat --- */
document.getElementById('clear-btn').addEventListener('click', () => {
  messagesBox.innerHTML = '';
  dbgLog("Chat cleared by user.");
});

/* --- Merge with Puter remote models (if available) --- */
async function mergePuterModels() {
  try {
    if (!window.puter) {
      dbgLog("puter.js loaded? ->", !!window.puter);
      return;
    }
    if (puter?.ai?.models) {
      dbgLog("puter.ai.models() available â€” fetching...");
      try {
        const remote = await puter.ai.models();
        dbgLog("Models from Puter:", remote);
        if (Array.isArray(remote)) {
          remote.forEach(m => {
            if (![...modelSelect.options].some(o => o.value === m)) {
              const opt = document.createElement("option");
              opt.value = m;
              opt.textContent = m;
              modelSelect.appendChild(opt);
            }
          });
          document.getElementById("models-count").textContent = modelSelect.options.length + " models (merged)";
        }
      } catch (err) {
        dbgLog("Could not fetch Puter models:", safeStringifyError(err));
      }
    } else {
      dbgLog("puter.ai.models not present (skipping).");
    }
  } catch (err) {
    dbgLog("Error probing Puter:", safeStringifyError(err));
  }
}

/* --- Run on page load --- */
(async () => {
  await loadModelsFromFile();
  await mergePuterModels();
  dbgLog("UI ready. Models loaded into dropdown.");
})();
</script>
</body>
</html>
