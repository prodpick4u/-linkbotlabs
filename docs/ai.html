<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Puter AI Playground</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; padding: 20px; }
    label { display: block; margin-top: 10px; }
    textarea, select, button { margin-top: 5px; padding: 6px; font-size: 14px; }
    .out { background: #222; padding: 10px; margin-top: 10px; min-height: 40px; white-space: pre-wrap; }
    h1, h2 { color: #4fc3f7; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Puter AI Playground</h1>

  <!-- CHAT -->
  <h2>Chat</h2>
  <label for="chat-model">Model</label>
  <select id="chat-model">
    <option value="default">Puter Default</option>
    <option value="gpt-4o-mini">OpenAI GPT-4o Mini</option>
  </select>

  <label for="chat-box">Chat Box</label>
  <select id="chat-box">
    <option value="standard" selected>Standard Chat Box</option>
    <option value="assistant">Assistant Style</option>
    <option value="casual">Casual Chat</option>
    <option value="developer">Developer Mode</option>
  </select>

  <textarea id="chat-prompt" rows="3" cols="40" placeholder="Ask something..."></textarea><br>
  <button id="chat-run">Run Chat</button>
  <button id="chat-speak">Speak Output</button>
  <div id="chat-out" class="out"></div>

  <!-- STREAM -->
  <h2>Streaming Chat</h2>
  <label for="stream-model">Model</label>
  <select id="stream-model">
    <option value="default">Puter Default</option>
    <option value="gpt-4o-mini">OpenAI GPT-4o Mini</option>
  </select>
  <textarea id="stream-prompt" rows="3" cols="40" placeholder="Stream a response..."></textarea><br>
  <button id="stream-run">Run Stream</button>
  <button id="stream-speak">Speak Output</button>
  <div id="stream-out" class="out"></div>

  <!-- SPEECH SETTINGS -->
  <h2>Speech Settings</h2>
  <label for="speech-lang">Language</label>
  <select id="speech-lang">
    <option value="en-US" selected>English (US)</option>
    <option value="en-GB">English (UK)</option>
    <option value="fr-FR">French</option>
    <option value="de-DE">German</option>
    <option value="es-ES">Spanish</option>
    <option value="it-IT">Italian</option>
  </select>

  <label for="speech-engine">Engine</label>
  <select id="speech-engine">
    <option value="standard">Standard</option>
    <option value="neural" selected>Neural</option>
    <option value="generative">Generative</option>
  </select>

  <label for="speech-voice">Voice</label>
  <select id="speech-voice">
    <option value="Joanna" selected>Joanna (Female)</option>
    <option value="Matthew">Matthew (Male)</option>
    <option value="Amy">Amy (Female)</option>
    <option value="Brian">Brian (Male)</option>
  </select>

<script>
/* ---------- Helpers ---------- */
function putText(el, text) { el.innerHTML = (text ?? '').toString(); }
function appendText(el, text) { el.innerHTML += (text ?? '').toString(); }

/* Extract clean text from Puter / OpenAI responses */
function normalizeNonStream(resp) {
  if (!resp) return "";
  if (typeof resp === "string") return resp;
  if (resp.output_text) return resp.output_text;
  if (resp.message) return resp.message;
  if (resp.text) return resp.text;
  if (resp.choices && resp.choices[0]?.message?.content) {
    return resp.choices[0].message.content;
  }
  return "[No text output found]";
}

/* ---------- CHAT ---------- */
document.getElementById('chat-run').addEventListener('click', async () => {
  const model = document.getElementById('chat-model').value;
  const chatBox = document.getElementById('chat-box').value;
  const prompt = document.getElementById('chat-prompt').value.trim();
  const out = document.getElementById('chat-out');
  if (!prompt) { putText(out, 'Please enter a prompt.'); return; }
  putText(out, 'Thinkingâ€¦');
  try {
    const resp = await puter.ai.chat(prompt, { model, chatBox });
    putText(out, normalizeNonStream(resp));
  } catch (e) { putText(out, 'Error: ' + (e?.message ?? e)); }
});

/* ---------- STREAM ---------- */
document.getElementById('stream-run').addEventListener('click', async () => {
  const model = document.getElementById('stream-model').value;
  const prompt = document.getElementById('stream-prompt').value.trim();
  const out = document.getElementById('stream-out');
  if (!prompt) { putText(out, 'Please enter a prompt.'); return; }
  putText(out, '');
  try {
    const stream = await puter.ai.chat(prompt, { model, stream: true });
    for await (const part of stream) {
      if (part?.output_text) appendText(out, part.output_text.replaceAll('\n','<br>'));
      else if (part?.message) appendText(out, part.message.replaceAll('\n','<br>'));
      else if (part?.text) appendText(out, part.text.replaceAll('\n','<br>'));
      else if (part?.choices?.[0]?.message?.content) appendText(out, part.choices[0].message.content.replaceAll('\n','<br>'));
    }
  } catch (e) { putText(out, 'Error: ' + (e?.message ?? e)); }
});

/* ---------- TEXT TO SPEECH ---------- */
async function speakText(text) {
  if (!text) return;

  const lang = document.getElementById("speech-lang").value;
  const engine = document.getElementById("speech-engine").value;
  const voice = document.getElementById("speech-voice").value;

  try {
    const result = await puter.ai.txt2speech(text, {
      language: lang,
      engine: engine,
      voice: voice
    });

    if (result instanceof HTMLAudioElement) {
      result.play();
    } else if (result?.audio instanceof Blob) {
      const url = URL.createObjectURL(result.audio);
      const audio = new Audio(url);
      audio.play();
    } else if (typeof result === "string") {
      const audio = new Audio(result);
      audio.play();
    } else {
      console.error("Unsupported TTS return format:", result);
      alert("Speech output not supported in this environment.");
    }
  } catch (e) {
    console.error("TTS error:", e);
    alert("Speech failed: " + (e.message ?? e));
  }
}

document.getElementById('chat-speak').addEventListener('click', () => {
  speakText(document.getElementById('chat-out').innerText);
});
document.getElementById('stream-speak').addEventListener('click', () => {
  speakText(document.getElementById('stream-out').innerText);
});
</script>
</body>
</html>
