<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LinkBotLabs AI Chat</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .card {
      background: #222;
      margin: 10px;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 4px #000;
      display: flex;
      flex-direction: column;
    }
    .output {
      flex: 1;
      min-height: 150px;
      max-height: 300px;
      overflow-y: auto;
      padding: 5px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #000;
      font-size: 14px;
    }
    .input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    input, select, button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    input {
      flex: 1;
    }
    button {
      background: #444;
      color: #fff;
    }
    #debug-panel {
      background: #111;
      color: #0f0;
      font-size: 12px;
      padding: 6px;
      max-height: 150px;
      overflow-y: auto;
      border-top: 1px solid #333;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;margin:10px 0;">ðŸ¤– LinkBotLabs AI Chat</h2>

  <!-- Chat Card -->
  <div class="card">
    <div id="chat-out" class="output"></div>
    <div class="input-area">
      <select id="chat-model"><option>Loading models...</option></select>
      <input id="chat-in" placeholder="Type your message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Streaming Card -->
  <div class="card">
    <div id="stream-out" class="output"></div>
    <div class="input-area">
      <select id="stream-model"><option>Loading models...</option></select>
      <input id="stream-in" placeholder="Stream test...">
      <button onclick="sendStream()">Stream</button>
    </div>
  </div>

  <!-- Debug Panel -->
  <div id="debug-panel"></div>

  <script>
    function logDebug(...args) {
      const panel = document.getElementById("debug-panel");
      const msg = args.map(a => typeof a === "object" ? JSON.stringify(a) : a).join(" ");
      panel.innerHTML += msg + "<br>";
      panel.scrollTop = panel.scrollHeight;
      console.log(...args);
    }

    // Load available models from Puter
    async function loadModels() {
      try {
        const models = await puter.ai.models.list();
        logDebug("ðŸ“¥ Loaded models:", models);

        const chatSelect = document.getElementById("chat-model");
        const streamSelect = document.getElementById("stream-model");

        chatSelect.innerHTML = "";
        streamSelect.innerHTML = "";

        models.forEach(m => {
          const opt1 = document.createElement("option");
          opt1.value = m.id;
          opt1.textContent = m.display_name ? `${m.display_name} (${m.id})` : m.id;
          chatSelect.appendChild(opt1);

          const opt2 = opt1.cloneNode(true);
          streamSelect.appendChild(opt2);
        });
      } catch (err) {
        logDebug("ðŸ’¥ Failed to load models:", err);
      }
    }

    function putText(container, text, sender = "ai") {
      const p = document.createElement("p");
      p.textContent = (sender === "user" ? "ðŸ§‘: " : "ðŸ¤–: ") + text;
      container.appendChild(p);
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById("chat-in");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";

      const chatBox = document.getElementById("chat-out");
      putText(chatBox, text, "user");

      const model = document.getElementById("chat-model").value;
      logDebug("ðŸš€ Sending:", text, "with model:", model);

      try {
        const resp = await puter.ai.chat(text, { model });
        logDebug("ðŸ“¥ Raw response:", resp);

        const out = resp.output_text || resp.message?.content || "[No text]";
        putText(chatBox, out, "ai");
      } catch (e) {
        logDebug("ðŸ’¥ Chat error:", e);
        putText(chatBox, "[Error: " + (e.message ?? e) + "]", "ai");
      }
    }

    async function sendStream() {
      const input = document.getElementById("stream-in");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";

      const streamBox = document.getElementById("stream-out");
      putText(streamBox, text, "user");

      const model = document.getElementById("stream-model").value;
      logDebug("ðŸš€ Streaming:", text, "with model:", model);

      try {
        const stream = await puter.ai.chat.stream(text, { model });
        for await (const chunk of stream) {
          logDebug("ðŸ“¥ Stream chunk:", chunk);
          if (chunk?.output_text) {
            putText(streamBox, chunk.output_text, "ai");
          }
        }
      } catch (e) {
        logDebug("ðŸ’¥ Stream error:", e);
        putText(streamBox, "[Stream error: " + (e.message ?? e) + "]", "ai");
      }
    }

    // Load models on startup
    loadModels();
  </script>
</body>
</html>
