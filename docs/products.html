<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Affiliate Products with AI Chat</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0d0d1a;
    color: #fff;
    margin: 0;
    padding: 20px;
  }
  .product-card {
    background: #1c1c2b;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }
  .product-card h2 { margin-top: 0; }
  button {
    background: #0078ff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    margin: 5px 0;
  }
  .chat-container {
    display: none;
    flex-direction: column;
    margin-top: 10px;
    background: #111;
    border-radius: 8px;
    padding: 10px;
  }
  .chat-box {
    background: #000;
    padding: 10px;
    border-radius: 6px;
    height: 200px;
    overflow-y: auto;
    margin-bottom: 8px;
    position: relative;
  }
  .chat-box:empty::before {
    content: attr(placeholder);
    color: #666;
    position: absolute;
    left: 10px;
    top: 10px;
    pointer-events: none;
  }
  .chat-bubble {
    padding: 6px 10px;
    margin: 4px 0;
    border-radius: 6px;
    max-width: 90%;
    word-wrap: break-word;
  }
  .user-bubble {
    background: #0078ff;
    color: white;
    align-self: flex-end;
  }
  .ai-bubble {
    background: #333;
    color: #fff;
    align-self: flex-start;
  }
  .controls {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  select, button {
    font-size: 14px;
  }
</style>
</head>
<body>

<div id="products"></div>

<script src="https://js.puter.com/v2/"></script>
<script>
const products = [
  { name: "AI Assistant Pro", description: "Your smart AI assistant for daily tasks.", link: "https://affiliate.example.com/pro" },
  { name: "Smart Home Hub", description: "Connect and control all your devices.", link: "https://affiliate.example.com/hub" }
];

// --- Normalize Puter AI Responses ---
function normalizeNonStream(resp) {
  if (typeof resp === 'string') return resp;
  if (resp?.output_text) return resp.output_text;
  if (resp?.text) return resp.text;
  if (resp?.message?.content) {
    if (Array.isArray(resp.message.content)) {
      const first = resp.message.content[0];
      return typeof first === 'string' ? first : (first?.text ?? JSON.stringify(resp.message.content));
    }
    return typeof resp.message.content === 'string' ? resp.message.content : JSON.stringify(resp.message.content);
  }
  return JSON.stringify(resp ?? {});
}

// --- Build Product Cards ---
const productsDiv = document.getElementById("products");

products.forEach(p => {
  const card = document.createElement("div");
  card.className = "product-card";
  card.innerHTML = `
    <h2>${p.name}</h2>
    <p>${p.description}</p>
    <a href="${p.link}" target="_blank"><button>View Product</button></a>
    <button class="askBtn">Ask AI</button>
    <div class="chat-container">
      <div class="chat-box" contenteditable="true" placeholder="Type your question here..."></div>
      <div class="controls">
        <button class="listenBtn">Listen</button>
        <button id="stopTTS">Stop</button>
        <select id="voiceSelect"></select>
        <select class="modelSelect">
          <option value="gpt-5-nano">GPT-5 Nano</option>
          <option value="gpt-5-mini">GPT-5 Mini</option>
          <option value="gpt-5">GPT-5</option>
        </select>
      </div>
    </div>
  `;
  productsDiv.appendChild(card);

  const askBtn = card.querySelector(".askBtn");
  const chatContainer = card.querySelector(".chat-container");
  const chatBox = card.querySelector(".chat-box");
  const ttsBtn = card.querySelector(".listenBtn");
  const modelSelect = card.querySelector(".modelSelect");

  askBtn.onclick = () => {
    const isHidden = chatContainer.style.display === "none";
    chatContainer.style.display = isHidden ? "flex" : "none";
    if (isHidden) {
      chatBox.focus();
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  };

  chatBox.addEventListener("keydown", async (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      const userText = chatBox.innerText.trim();
      if (!userText) return;

      const userBubble = document.createElement("div");
      userBubble.className = "chat-bubble user-bubble";
      userBubble.textContent = userText;
      chatBox.appendChild(userBubble);

      chatBox.innerHTML = "";
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const resp = await puter.ai.chat(userText, { model: modelSelect.value });
        const aiText = normalizeNonStream(resp);
        await typeAIResponse(chatBox, aiText);
      } catch (e) {
        await typeAIResponse(chatBox, "⚠️ Error: " + (e?.message ?? e));
      }
    }
  });

  ttsBtn.onclick = () => {
    const aiBubbles = chatBox.querySelectorAll(".ai-bubble");
    if (aiBubbles.length === 0) {
      playTTS(p.description);
      return;
    }
    const lastAIBubble = aiBubbles[aiBubbles.length - 1];
    playTTS(lastAIBubble.textContent);
  };
});

// --- Typing Effect + Auto TTS ---
async function typeAIResponse(chatBox, text) {
  const bubble = document.createElement("div");
  bubble.className = "chat-bubble ai-bubble typing-bubble";
  chatBox.appendChild(bubble);
  chatBox.scrollTop = chatBox.scrollHeight;

  for (let i = 0; i < text.length; i++) {
    bubble.textContent = text.slice(0, i + 1);
    chatBox.scrollTop = chatBox.scrollHeight;
    await new Promise(r => setTimeout(r, 20));
  }

  bubble.classList.remove("typing-bubble");
  playTTS(text);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// --- TTS Setup ---
let synth = window.speechSynthesis;
let utter;
let selectedVoiceName = null;

function populateVoiceSelects() {
  const voices = synth.getVoices();
  if (!voices.length) {
    setTimeout(populateVoiceSelects, 250);
    return;
  }
  const selects = document.querySelectorAll('#voiceSelect');
  selects.forEach(select => {
    select.innerHTML = '';
    voices.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      select.appendChild(opt);
    });
    let defaultVoice = voices.find(v => v.lang.startsWith("en-")) || voices[0];
    selectedVoiceName = defaultVoice.name;
    select.value = selectedVoiceName;
  });
}
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = populateVoiceSelects;
} else {
  populateVoiceSelects();
}
document.addEventListener("change", e => {
  if (e.target.id === "voiceSelect") {
    selectedVoiceName = e.target.value;
  }
});

function playTTS(text) {
  if (!text) return;
  if (synth.speaking) synth.cancel();

  utter = new SpeechSynthesisUtterance(text);
  let voices = synth.getVoices();
  let chosen = voices.find(v => v.name === selectedVoiceName);
  if (!chosen) chosen = voices.find(v => v.lang.startsWith("en-")) || voices[0];
  utter.voice = chosen;

  synth.speak(utter);
}
document.getElementById('stopTTS').onclick = () => {
  if (synth.speaking) synth.cancel();
};
</script>

</body>
</html>
